map ValidationwithMultipleSKU(string organization_id, string salesorder_id, string order_id, list refund_line_items, list zoho_line_items)
{
lineItems = List();
detailsList = List();
totalReturnAmount = 0;
allItemsDetails = List();
hasErrors = false;
errorMessages = List();
failedItems = List();
// Process each refunded item
for each  refundItem in refund_line_items
{
	refunded_sku = refundItem.get("line_item").get("sku");
	refunded_quantity = refundItem.get("quantity");
	foundItem = false;
	// Find matching item in Zoho sales order
	for each  item in zoho_line_items
	{
		if(item.get("sku") == refunded_sku)
		{
			foundItem = true;
			qtyOrdered = item.get("quantity");
			qtyReturned = item.get("quantity_returned");
			qtyInvoiced = item.get("quantity_invoiced");
			qtyShipped = item.get("quantity_shipped");
			qtyManuallyFulfilled = item.get("quantity_manuallyfulfilled");
			itemName = item.get("name");
			rate = item.get("rate");
			// Use the best available quantity
			baseQty = qtyInvoiced;
			if(qtyInvoiced == 0)
			{
				if(qtyManuallyFulfilled > 0)
				{
					baseQty = qtyManuallyFulfilled;
				}
				else if(qtyShipped > 0)
				{
					baseQty = qtyShipped;
				}
				else
				{
					baseQty = qtyOrdered;
				}
			}
			availableToReturn = baseQty - qtyReturned;
			remainingAfterReturn = availableToReturn - refunded_quantity;
			returnAmount = rate * refunded_quantity;
			info "Processing: " + itemName;
			info "SKU: " + refunded_sku;
			info "Base Quantity: " + baseQty + ", Already Returned: " + qtyReturned;
			info "Available to Return: " + availableToReturn + ", Requesting: " + refunded_quantity;
			// VALIDATION: Check if no items available
			if(availableToReturn == 0)
			{
				hasErrors = true;
				errorMsg = "All items already returned";
				errorMessages.add("❌ " + itemName + " (SKU: " + refunded_sku + ") - " + errorMsg);
				// Store failed item details for email
				failedItem = Map();
				failedItem.put("name",itemName);
				failedItem.put("sku",refunded_sku);
				failedItem.put("quantity_ordered",qtyOrdered);
				failedItem.put("quantity_returned",qtyReturned);
				failedItem.put("quantity_requesting",refunded_quantity);
				failedItem.put("available",availableToReturn);
				failedItem.put("error","All items already returned");
				failedItems.add(failedItem);
				info "❌ " + itemName + " (SKU: " + refunded_sku + ") - " + errorMsg;
				continue;
			}
			// VALIDATION: Check if trying to return more than available
			if(refunded_quantity > availableToReturn)
			{
				hasErrors = true;
				errorMsg = "Cannot return " + refunded_quantity + " items. Only " + availableToReturn + " available";
				errorMessages.add("❌ " + itemName + " (SKU: " + refunded_sku + ") - " + errorMsg);
				// Store failed item details for email
				failedItem = Map();
				failedItem.put("name",itemName);
				failedItem.put("sku",refunded_sku);
				failedItem.put("quantity_ordered",qtyOrdered);
				failedItem.put("quantity_returned",qtyReturned);
				failedItem.put("quantity_requesting",refunded_quantity);
				failedItem.put("available",availableToReturn);
				failedItem.put("error","Insufficient quantity: Need " + refunded_quantity + ", only " + availableToReturn + " available");
				failedItems.add(failedItem);
				info "❌ " + itemName + " (SKU: " + refunded_sku + ") - " + errorMsg;
				continue;
			}
			// Validation passed - add to line items
			itemMap = Map();
			itemMap.put("item_id",item.get("item_id"));
			itemMap.put("salesorder_item_id",item.get("line_item_id"));
			itemMap.put("quantity",refunded_quantity);
			lineItems.add(itemMap);
			// Store item details for email
			itemDetail = Map();
			itemDetail.put("name",itemName);
			itemDetail.put("sku",refunded_sku);
			itemDetail.put("quantity_ordered",qtyOrdered);
			itemDetail.put("quantity_returned",qtyReturned);
			itemDetail.put("quantity_returning",refunded_quantity);
			itemDetail.put("available",availableToReturn);
			itemDetail.put("remaining",remainingAfterReturn);
			itemDetail.put("rate",rate);
			itemDetail.put("amount",returnAmount);
			// Add status message
			if(remainingAfterReturn == 0)
			{
				itemDetail.put("status","All items returned");
			}
			else
			{
				itemDetail.put("status","Partial return");
			}
			allItemsDetails.add(itemDetail);
			totalReturnAmount = totalReturnAmount + returnAmount;
			info "✓ Added to return: " + refunded_quantity + " x " + itemName;
			break;
		}
	}
	// Check if SKU was found
	if(!foundItem)
	{
		hasErrors = true;
		errorMsg = "SKU not found in sales order";
		errorMessages.add("❌ SKU '" + refunded_sku + "' - " + errorMsg);
		// Store failed item for email
		failedItem = Map();
		failedItem.put("name","Unknown Item");
		failedItem.put("sku",refunded_sku);
		failedItem.put("quantity_ordered","N/A");
		failedItem.put("quantity_returned","N/A");
		failedItem.put("quantity_requesting",refunded_quantity);
		failedItem.put("available","N/A");
		failedItem.put("error","SKU not found in sales order");
		failedItems.add(failedItem);
		info "❌ SKU '" + refunded_sku + "' - " + errorMsg;
	}
}
// If there are validation errors and no valid items - send error email
if(hasErrors && lineItems.size() == 0)
{
	info "Validation failed - no valid items to return";
	// Build error email
	htmlEmail = "<!DOCTYPE html>";
	htmlEmail = htmlEmail + "<html><head><style>";
	htmlEmail = htmlEmail + "body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }";
	htmlEmail = htmlEmail + ".container { max-width: 800px; margin: 0 auto; padding: 20px; }";
	htmlEmail = htmlEmail + ".header { background-color: #f44336; color: white; padding: 20px; text-align: center; border-radius: 5px; }";
	htmlEmail = htmlEmail + ".info-box { background-color: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ff9800; }";
	htmlEmail = htmlEmail + "table { width: 100%; border-collapse: collapse; margin: 20px 0; }";
	htmlEmail = htmlEmail + "th { background-color: #f44336; color: white; padding: 12px; text-align: left; }";
	htmlEmail = htmlEmail + "td { padding: 10px; border-bottom: 1px solid #ddd; }";
	htmlEmail = htmlEmail + ".error-row { background-color: #ffebee; }";
	htmlEmail = htmlEmail + ".error-text { color: #d32f2f; font-weight: bold; }";
	htmlEmail = htmlEmail + "</style></head><body>";
	htmlEmail = htmlEmail + "<div class='container'>";
	htmlEmail = htmlEmail + "<div class='header'><h1>❌ Sales Return Failed</h1></div>";
	htmlEmail = htmlEmail + "<div class='info-box'>";
	htmlEmail = htmlEmail + "<p><strong>Date:</strong> " + zoho.currentdate.toString("dd-MMM-yyyy") + "</p>";
	htmlEmail = htmlEmail + "<p><strong>Sales Order ID:</strong> " + salesorder_id + "</p>";
	htmlEmail = htmlEmail + "<p><strong>Shopify Order ID:</strong> " + order_id + "</p>";
	htmlEmail = htmlEmail + "</div>";
	htmlEmail = htmlEmail + "<h2>Failed Items</h2>";
	htmlEmail = htmlEmail + "<table>";
	htmlEmail = htmlEmail + "<tr><th>Item Name</th><th>SKU</th><th>Ordered</th><th>Returned</th><th>Requesting</th><th>Available</th><th>Error</th></tr>";
	for each  failed in failedItems
	{
		htmlEmail = htmlEmail + "<tr class='error-row'>";
		htmlEmail = htmlEmail + "<td>" + failed.get("name") + "</td>";
		htmlEmail = htmlEmail + "<td>" + failed.get("sku") + "</td>";
		htmlEmail = htmlEmail + "<td>" + failed.get("quantity_ordered") + "</td>";
		htmlEmail = htmlEmail + "<td>" + failed.get("quantity_returned") + "</td>";
		htmlEmail = htmlEmail + "<td>" + failed.get("quantity_requesting") + "</td>";
		htmlEmail = htmlEmail + "<td>" + failed.get("available") + "</td>";
		htmlEmail = htmlEmail + "<td class='error-text'>" + failed.get("error") + "</td>";
		htmlEmail = htmlEmail + "</tr>";
	}
	htmlEmail = htmlEmail + "</table>";
	htmlEmail = htmlEmail + "</div></body></html>";
	errorResponse = Map();
	errorResponse.put("code","VALIDATION_ERROR");
	errorResponse.put("message",errorMessages.toString());
	errorResponse.put("status","error");
	errorResponse.put("send_email",true);
	errorResponse.put("email_message",htmlEmail);
	return errorResponse;
}
// If no valid items to return
if(lineItems.size() == 0)
{
	info "No items to return";
	errorResponse = Map();
	errorResponse.put("code","NO_ITEMS_TO_RETURN");
	errorResponse.put("message","No valid items to return");
	errorResponse.put("status","error");
	errorResponse.put("send_email",false);
	return errorResponse;
}
info "Creating return with " + lineItems.size() + " items";
// Build details list for console logs
detailsList.add("=================================");
detailsList.add("    SALES RETURN DETAILS");
detailsList.add("=================================");
detailsList.add("");
detailsList.add("Date: " + zoho.currentdate.toString("dd-MMM-yyyy"));
detailsList.add("Sales Order ID: " + salesorder_id);
detailsList.add("Shopify Order ID: " + order_id);
detailsList.add("");
detailsList.add("--- Items Being Returned ---");
detailsList.add("");
itemNumber = 1;
for each  itemDetail in allItemsDetails
{
	detailsList.add("Item " + itemNumber + ":");
	detailsList.add("  Name: " + itemDetail.get("name"));
	detailsList.add("  SKU: " + itemDetail.get("sku"));
	detailsList.add("  Unit Price: ₹" + itemDetail.get("rate"));
	detailsList.add("  Quantity Ordered: " + itemDetail.get("quantity_ordered"));
	detailsList.add("  Already Returned: " + itemDetail.get("quantity_returned"));
	detailsList.add("  Returning Now: " + itemDetail.get("quantity_returning"));
	detailsList.add("  Remaining After Return: " + itemDetail.get("remaining"));
	detailsList.add("  Return Amount: ₹" + itemDetail.get("amount"));
	detailsList.add("  Status: " + itemDetail.get("status"));
	detailsList.add("");
	itemNumber = itemNumber + 1;
}
detailsList.add("--- Summary ---");
detailsList.add("Total Items: " + allItemsDetails.size());
detailsList.add("Total Return Amount: ₹" + totalReturnAmount);
detailsList.add("=================================");
// Create sales return
salesReturnMap = Map();
salesReturnMap.put("salesorder_id",salesorder_id);
salesReturnMap.put("date",zoho.currentdate.toString("yyyy-MM-dd"));
salesReturnMap.put("line_items",lineItems);
salesReturnMap.put("notes","Shopify Refund - Order " + order_id);
info "Calling Zoho Inventory API...";
try 
{
	response = zoho.inventory.createRecord("salesreturns",organization_id,salesReturnMap,"zoho_inventory");
	info "API Response Code: " + response.get("code");
	// Check for successful response
	if(response.get("code") == 0 || response.containsKey("salesreturn"))
	{
		// SUCCESS - Build HTML email message
		info "";
		info "✅ Sales return created successfully!";
		// Print to console logs
		for each  line in detailsList
		{
			info line;
		}
		// Get return ID
		returnId = "";
		if(response.containsKey("salesreturn"))
		{
			salesreturnData = response.get("salesreturn");
			if(salesreturnData.containsKey("salesreturn_number"))
			{
				returnId = salesreturnData.get("salesreturn_number");
			}
		}
		info "";
		info "✅ SUCCESS: Sales Return Created!";
		info "Return ID: " + returnId;
		info "";
		// Build HTML email with table
		htmlEmail = "<!DOCTYPE html>";
		htmlEmail = htmlEmail + "<html><head><style>";
		htmlEmail = htmlEmail + "body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }";
		htmlEmail = htmlEmail + ".container { max-width: 900px; margin: 0 auto; padding: 20px; }";
		htmlEmail = htmlEmail + ".header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; border-radius: 5px; }";
		htmlEmail = htmlEmail + ".info-box { background-color: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }";
		htmlEmail = htmlEmail + ".info-box p { margin: 5px 0; }";
		htmlEmail = htmlEmail + "table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 13px; }";
		htmlEmail = htmlEmail + "th { background-color: #4CAF50; color: white; padding: 12px 8px; text-align: left; font-weight: bold; }";
		htmlEmail = htmlEmail + "td { padding: 10px 8px; border-bottom: 1px solid #ddd; }";
		htmlEmail = htmlEmail + "tr:hover { background-color: #f5f5f5; }";
		htmlEmail = htmlEmail + ".total-row { background-color: #e8f5e9; font-weight: bold; }";
		htmlEmail = htmlEmail + ".footer { background-color: #f5f5f5; padding: 15px; margin-top: 20px; text-align: center; border-radius: 5px; font-size: 12px; color: #666; }";
		htmlEmail = htmlEmail + ".success-badge { background-color: #4CAF50; color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; }";
		htmlEmail = htmlEmail + ".warning-badge { background-color: #ff9800; color: white; padding: 5px 10px; border-radius: 3px; font-size: 11px; display: inline-block; margin-top: 5px; }";
		htmlEmail = htmlEmail + ".partial-badge { background-color: #2196F3; color: white; padding: 5px 10px; border-radius: 3px; font-size: 11px; display: inline-block; margin-top: 5px; }";
		htmlEmail = htmlEmail + "</style></head><body>";
		htmlEmail = htmlEmail + "<div class='container'>";
		// Header
		htmlEmail = htmlEmail + "<div class='header'>";
		htmlEmail = htmlEmail + "<h1>✅ Sales Return Created Successfully</h1>";
		htmlEmail = htmlEmail + "</div>";
		// Info Box
		htmlEmail = htmlEmail + "<div class='info-box'>";
		htmlEmail = htmlEmail + "<p><strong>Date:</strong> " + zoho.currentdate.toString("dd-MMM-yyyy") + "</p>";
		htmlEmail = htmlEmail + "<p><strong>Sales Order number:</strong> " + salesorder_id + "</p>";
		htmlEmail = htmlEmail + "<p><strong>Sales Order ID:</strong> " + order_id + "</p>";
		htmlEmail = htmlEmail + "<p><strong>Return ID:</strong> <span class='success-badge'>" + returnId + "</span></p>";
		htmlEmail = htmlEmail + "</div>";
		// Items Table
		htmlEmail = htmlEmail + "<h2>Items Returned</h2>";
		htmlEmail = htmlEmail + "<table>";
		htmlEmail = htmlEmail + "<thead>";
		htmlEmail = htmlEmail + "<tr>";
		htmlEmail = htmlEmail + "<th>#</th>";
		htmlEmail = htmlEmail + "<th>Item Name</th>";
		htmlEmail = htmlEmail + "<th>SKU</th>";
		htmlEmail = htmlEmail + "<th style='text-align: right;'>Unit Price</th>";
		htmlEmail = htmlEmail + "<th style='text-align: center;'>Ordered</th>";
		htmlEmail = htmlEmail + "<th style='text-align: center;'>Already Ret.</th>";
		htmlEmail = htmlEmail + "<th style='text-align: center;'><strong>Returning</strong></th>";
		htmlEmail = htmlEmail + "<th style='text-align: center;'>Remaining</th>";
		htmlEmail = htmlEmail + "<th style='text-align: right;'><strong>Amount</strong></th>";
		htmlEmail = htmlEmail + "<th>Status</th>";
		htmlEmail = htmlEmail + "</tr>";
		htmlEmail = htmlEmail + "</thead>";
		htmlEmail = htmlEmail + "<tbody>";
		itemNum = 1;
		for each  itemDetail in allItemsDetails
		{
			htmlEmail = htmlEmail + "<tr>";
			htmlEmail = htmlEmail + "<td>" + itemNum + "</td>";
			htmlEmail = htmlEmail + "<td>" + itemDetail.get("name") + "</td>";
			htmlEmail = htmlEmail + "<td>" + itemDetail.get("sku") + "</td>";
			htmlEmail = htmlEmail + "<td style='text-align: right;'>₹" + itemDetail.get("rate") + "</td>";
			htmlEmail = htmlEmail + "<td style='text-align: center;'>" + itemDetail.get("quantity_ordered") + "</td>";
			htmlEmail = htmlEmail + "<td style='text-align: center;'>" + itemDetail.get("quantity_returned") + "</td>";
			htmlEmail = htmlEmail + "<td style='text-align: center;'><strong>" + itemDetail.get("quantity_returning") + "</strong></td>";
			htmlEmail = htmlEmail + "<td style='text-align: center;'>" + itemDetail.get("remaining") + "</td>";
			htmlEmail = htmlEmail + "<td style='text-align: right;'><strong>₹" + itemDetail.get("amount") + "</strong></td>";
			// Status column with badge
			htmlEmail = htmlEmail + "<td>";
			if(itemDetail.get("remaining") == 0)
			{
				htmlEmail = htmlEmail + "<span class='warning-badge'>✅ All items returned for this product</span>";
			}
			else
			{
				htmlEmail = htmlEmail + "<span class='partial-badge'>✓ Partial return</span>";
			}
			htmlEmail = htmlEmail + "</td>";
			htmlEmail = htmlEmail + "</tr>";
			itemNum = itemNum + 1;
		}
		// Total Row
		htmlEmail = htmlEmail + "<tr class='total-row'>";
		htmlEmail = htmlEmail + "<td colspan='8' style='text-align: right;'><strong>TOTAL:</strong></td>";
		htmlEmail = htmlEmail + "<td style='text-align: right;'><strong>₹" + totalReturnAmount + "</strong></td>";
		htmlEmail = htmlEmail + "<td></td>";
		htmlEmail = htmlEmail + "</tr>";
		htmlEmail = htmlEmail + "</tbody>";
		htmlEmail = htmlEmail + "</table>";
		// Show failed items if any (partial success)
		if(failedItems.size() > 0)
		{
			htmlEmail = htmlEmail + "<div style='background-color: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ff9800;'>";
			htmlEmail = htmlEmail + "<h3 style='color: #ff6f00; margin-top: 0;'>⚠️ Some Items Could Not Be Returned</h3>";
			htmlEmail = htmlEmail + "<table>";
			htmlEmail = htmlEmail + "<tr><th>Item Name</th><th>SKU</th><th>Requested</th><th>Available</th><th>Reason</th></tr>";
			for each  failed in failedItems
			{
				htmlEmail = htmlEmail + "<tr style='background-color: #ffebee;'>";
				htmlEmail = htmlEmail + "<td>" + failed.get("name") + "</td>";
				htmlEmail = htmlEmail + "<td>" + failed.get("sku") + "</td>";
				htmlEmail = htmlEmail + "<td style='text-align: center;'>" + failed.get("quantity_requesting") + "</td>";
				htmlEmail = htmlEmail + "<td style='text-align: center;'>" + failed.get("available") + "</td>";
				htmlEmail = htmlEmail + "<td style='color: #d32f2f;'>" + failed.get("error") + "</td>";
				htmlEmail = htmlEmail + "</tr>";
			}
			htmlEmail = htmlEmail + "</table>";
			htmlEmail = htmlEmail + "</div>";
		}
		// Summary
		htmlEmail = htmlEmail + "<div class='info-box'>";
		htmlEmail = htmlEmail + "<h3>Summary</h3>";
		htmlEmail = htmlEmail + "<p><strong>Total Items Returned:</strong> " + allItemsDetails.size() + "</p>";
		htmlEmail = htmlEmail + "<p><strong>Total Return Amount:</strong> ₹" + totalReturnAmount + "</p>";
		if(failedItems.size() > 0)
		{
			htmlEmail = htmlEmail + "<p style='color: #ff6f00;'><strong>Failed Items:</strong> " + failedItems.size() + "</p>";
		}
		htmlEmail = htmlEmail + "</div>";
		// Footer
		htmlEmail = htmlEmail + "<div class='footer'>";
		htmlEmail = htmlEmail + "<p>This is an automated notification from Zoho Flow</p>";
		htmlEmail = htmlEmail + "<p>Sales return has been successfully created in Zoho Inventory</p>";
		htmlEmail = htmlEmail + "</div>";
		htmlEmail = htmlEmail + "</div>";
		htmlEmail = htmlEmail + "</body></html>";
		response.put("email_message",htmlEmail);
		response.put("status","success");
		response.put("return_id",returnId);
		response.put("send_email",true);
		return response;
	}
	else
	{
		// API returned an error
		info "❌ FAILED: " + response.get("message");
		response.put("status","failed");
		response.put("send_email",false);
		return response;
	}
}
catch (e)
{
	info "❌ Exception occurred: " + e.toString();
	errorResponse = Map();
	errorResponse.put("code","EXCEPTION");
	errorResponse.put("message","Error creating sales return: " + e.toString());
	errorResponse.put("status","failed");
	errorResponse.put("send_email",false);
	return errorResponse;
}
}
